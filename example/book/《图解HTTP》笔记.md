---
title: 《图解HTTP》笔记
date: 2020-11-14
categories:
 - 书籍
tags:
 - HTTP
---

## 一、Web和网络基础

### 1.1 网络基础TCP/IP

#### 1.1.1 TCP/IP 协议族

![book-http/1573642109711](/book-http/1573642109711.png)

TCP/IP是互联网相关的各类协议族的总称，但也有说话表示，TCP/IP是指TCP和IP两种协议，还有一种说法认为，TCP/IP是在IP协议的通信过程中，使用到的协议族的统称。

#### 1.1.2 TCP/IP的分层管理

TCP/IP分别分为4层：应用层、传输层、网络层、数据链路层。

应用层：应用层决定了向用户提供服务时通信的活动，其中它包含了各类服务：比如FTP，DNS，telnet，HTTP等

传输层：传输层对于上层应用层，提供处于网络连接中的两台计算机之间的数据传输：主要是两个不同性质的协议：TCP，UDP

网络层：网络层用于处理网络上流动的数据包，数据包是网络传输的最小数据单位，该层规定了通过怎样的路径到达对方计算机，并把数据传送给对方，网络层的作用就是在众多传输立线路中选择一条（IP协议也在这层）

链路层：用于处理连接网络的硬件部分，包括控制操作系统，硬件的设备驱动等

#### 1.1.3 TCP/IP通信传输流

![book-http/1573697018788](/book-http/1573697018788.png)

发送端在层与层之间传输数据时，每经过一层时必定被打上一个该层所属的首部信息，反之，接收端在层与层传输数据时，每经过一层时会把对应的首部消去

### 1.2与HTTP关系密切的协议：IP、TCP和DNS

#### 1.2.1 传输协议IP

IP属于网络层，其作用是把各种数据包传送给对方，而要保证确实传送到对方那里，需要满足各种条件，最重要的是IP地址和MAC地址。

IP地址指明了被分配的地址，MAC是网卡所属的固定地址，IP间的通信会采用ARP协议，去根据IP反查MAC地址

![book-http/1573697493030](/book-http/1573697493030.png)

#### 1.2.2确保可靠性的TCP协议

TCP输入传输层，提供可靠的字节流服务。TCP协议为了更容易传送大数据才把数据分割，而且它能够确认数据最终是否送达到对方

TCP三次握手：

首先客户端向服务端发送一个带SYN标志的数据给对方，对方收到后回传一个带SYN/ACK的标志给客户端，最后客户端发送一个带ACK的给服务端，然后开始通信

![book-http/1573699136449](/book-http/1573699136449.png)

为什么不是两次和四次？因为三次是最基本的，类似于A对B说，你能听到我说话吗？B=>A，可以，那你能听到我说话吗？A：可以

四次挥手：

首先客户端向服务端发送一个FIN，服务端收到后回复一个ACK=FIN+SEQ，然后服务端向客户端发送一个FIN，告诉客户端关闭程序，客户端收到FIN后恢复一个ACK=FIN+SEQ，告诉服务端关闭

为什么要四次挥手，因为服务端收到FIN时候，只表示客户端没有数据再发送了，但是数据是否发送完整未知。然后再发送FIN给客户端，客户端确认后再回复服务端。

#### 1.2.3 负责解析域名的DNS

![book-http/1573699694637](/book-http/1573699694637.png)

![book-http/1573699996258](/book-http/1573699996258.png)

#### 1.2.4 各种协议与 HTTP 协议的关系

![book-http/1573700097360](/book-http/1573700097360.png)

#### 1.2.5 URL和URI

URL是个表示资源位置的字符串，一般情况下，而URI是统一资源标识符，用来标识唯一的资源。URI格式：

![book-http/1573701912687](/book-http/1573701912687.png)

## 二、简单的HTTP协议

### 2.1 基本的HTTP请求方法

#### 2.1.1 HTTP/1.0和HTTP/1.1支持的方法

![book-http/1573709284934](/book-http/1573709284934.png)

### 2.2持久连接节省通信量

HTTP初始版本中，每进行一次HTTP通信就要断开一次TCP连接

![book-http/1573709361485](/book-http/1573709361485.png)

#### 2.2.1 持久连接

HTTP/1.1想出了持久连接也称HTTPkeep-alive的方法。持久连接的特点是，只要任意一端没有明确提出断开连接，则保持TCP连接状态

![book-http/1573709463141](/book-http/1573709463141.png)

在HTTP/1.1中，默认所有链接都是持久链接。另外：持久连接是顺序化的，只有在请求1的响应收到后，才会发送请求2

#### 2.2.2 管线化

持久连接是的多数请求以管线化方式发送成为可能，从前发送请求需等待并接收响应，才能发送下一个请求。管线化技术出现后，不用等待相应也可直接发送下一个请求

![book-http/1573710579464](/book-http/1573710579464.png)

管线化只有GET和HEAD支持，而POST有所限制，初次创建不用应启动管线化，因为对方服务器不一定支持HTTP/1.1，另外：现在很多服务端对管线化支持并不好，Chrome和Firefox默认不开启管线化支持。管线化在接收response返回时，也必须依顺序接收，如果前一个请求遇到了阻塞，后面的请求即使已经处理完毕了，仍然需要等待阻塞的请求处理完毕。这种情况就如图中第三种，第一个请求阻塞后，后面的请求都需要等待，这也就是队头阻塞。

## 三、HTTP报文内的HTTP信息

### 3.1 HTTP报文

HTTP报文可大致分为报文首部和报文主体两快，两者由最初出现的空行CR+LF划分。通常，并不一定要有报文主体。

![book-http/1573711871592](/book-http/1573711871592.png)

### 3.2 请求报文和响应报文的结构

![book-http/1573712049975](/book-http/1573712049975.png)

![book-http/1573712062144](/book-http/1573712062144.png)

### 3.3 编码提升传输速率

#### 3.3.1 报文主体和实体主体的差异

报文（message）：8位组字节流组成，通过HTTP通信传输

实体（entity）：作为请求或响应的有效荷载数据被传输，由实体首部和实体主体组成

#### 3.3.2 压缩传输的内容编码

常用的内容编码以下几种：

GZIP、compress(UNIX系统的标准压缩)、deflate、identity（不进行压缩）

#### 3.3.3 分割发送的分块传输编码

![book-http/1573712552536](/book-http/1573712552536.png)

分块传输编码会将实体主体分成多个部分（块）。每一块都会用十六
进制来标记块的大小，而实体主体的最后一块会使用“0(CR+LF)”来标
记。

### 3.4 多种数据的多部分对象集合

发送邮件时，邮件里可以写入文字和多种附件，这是因为采用了MIME

多部分对象集合包含的对象如下：

multipart/form-data：Web表单文件上传时使用

multipart/byteranges：状态码206，响应报文包含了多个范围的内容时使用

multipart/form-data

multipart/byteranges

### 3.5 获取部分内容的范围请求

对一份 10 000 字节大小的资源，如果使用范围请求，可以只请求
5001~10 000 字节内的资源。

![book-http/1573714220430](/book-http/1573714220430.png)

![book-http/1573714246895](/book-http/1573714246895.png)

针对范围请求，响应会返回状态码206，如果服务端无法响应范围请求，则会返回状态码200和完整的实体内容

### 3.6 内容协商返回最合适的内容

内容协商机制是指客户端和服务端就响应内容资源的交涉，然后提供最合适的资源。

判断基准:Accept、Accept-Charset、Accept-Encoding、Accept-Language、Content-Language

## 四、返回的HTTP状态码

状态码类别：

![book-http/1573625606783](/book-http/1573625606783.png)

### 4.1 2XX成功

2XX代表请求被正常处理了

#### 4.1.1 200 OK

表示客户端发出的请求在服务端被正常处理了

#### 4.1.2 204 No Content

表示改请求已被服务器接受并且成功处理，但是返回的相应报文中不含实体的主体部分，也就是说返回了204，浏览器页面不发生更新。

#### 4.1.3 206 Partial Content

表示客户端进行了范围请求，而服务器成功执行了这部分的GET请求。相应报文中包含由Content-Range指定的范围的实体内容。举例：多次请求加载一张图片，每次都会指定加载的范围。

### 4.2 3XX重定向

3XX代表浏览器需要执行某些特殊的处理以正确处理请求

#### 4.2.1 301 Move Permanently

永久重定向，表示该资源已经被分配了新的URI，以后应使用资源现在指向的URI，

#### 4.2.2 302 Found

临时重定向，表示资源已经被重新分配了URL，希望用户本次能使用新的URL访问，但是这只是临时的，不是永久

#### 4.2.3 303 See Other

表示由于请求对应的资源存在另一个URI，应该GET方法定向获取请求的资源

#### 4.2.4 304 Not Modified

表示客户端访问发送附带条件的请求时，服务端允许请求访问，但是未满足条件的情况，返回的内容不包含任何相应的主体部分

#### 4.2.5 307 Temporary Redirect

临时重定向，和302类似。

### 4.3 4XX客户端错误

4XX表示客户端是发生错误原因的所在

#### 4.3.1 400 Bad Request

表示请求报文中存在语法错误，需要修改内容后重新发送请求。浏览器会像200 OK一样处理该状态

#### 4.3.2 401 Unauthorized

表示该请求需要通过HTTP认证(BASIC认证、DIGEST认证)的认证信息。另外若之前已进行过1次请求，则表示用户认证失败

#### 4.3.3 403 Forbidden

表示对请求资源的访问被服务器拒绝了。未获得文件系统的访问授权，或者IP未授权等都会引发这个问题

#### 4.3.4 404 Not Found

该状态吗表明服务器上无法找到请求的资源。

### 4.4 5XX 服务器错误

5XX表示错误发生在服务器端

#### 4.4.1 500 Internal Server Error

表示服务器执行请求的时候发生了错误，可能是Web应用程序的bug

#### 4.4.2 503 Service Unavailable

表示服务器暂时处理超负荷或者停机维护状态

## 五、HTTP首部

### 5.1 HTTP报文首部

![book-http/1573715716061](/book-http/1573715716061.png)

报文首部由几个字段构成

HTTP请求报文：由方法、URI、HTTP版本、HTTP首部字段等部分构成

![book-http/1573715799162](/book-http/1573715799162.png)

![book-http/1573715845931](/book-http/1573715845931.png)

HTTP响应报文：由HTTP版本、状态码、HTTP首部字段组成

![book-http/1573715897930](/book-http/1573715897930.png)

![book-http/1573715911178](/book-http/1573715911178.png)

### 5.2 HTTP首部字段

#### 5.2.1 4种HTTP首部字段类型

通用首部字段（General Header Fields）

请求首部字段（Request Header Fields）

响应首部字段（Response Header Fields）

实体首部字段（Entity Header Fields）

#### 5.2.2 HTTP/1.1首部字段一览

通用首部字段

![book-http/1573716149544](/book-http/1573716149544.png)

请求首部字段

![book-http/1573716164363](/book-http/1573716164363.png)

响应首部字段

![book-http/1573716179608](/book-http/1573716179608.png)

实体首部字段

![book-http/1573716195301](/book-http/1573716195301.png)

### 5.3 HTTP/1.1 通用首部字段

#### 5.3.1 Cache-Control

用于操作缓存的工作机制，参数"，"分割

Cache-Control: private, max-age=0, no-cache

![book-http/1573716365646](/book-http/1573716365646.png)

注意：从字面意思上很容易把 no-cache 误解成为不缓存，但事实上 no-cache 代表不缓
存过期的资源，缓存会向源服务器进行有效期确认后处理资源，也许称为 do-notserve-from-cache-without-revalidation 更合适。no-store 才是真正地不进行缓存，请
读者注意区别理解

#### 5.3.2 Connection

Connection首部字段具有：1. 控制不再转发给代理的首部字段 2、管理持久连接

另外：HTTP/1.1默认的都是持久连接

#### 5.3.3 Date

表示HTTP报文创建的日期和时间

#### 5.3.4 Pragma

是1.1之前的遗留字段，Pragma: no-cache 表示中间件服务器不返回缓存的资源

#### 5.3.5 Thailer

该字段会实现说明在报文主体后记录了哪些首部字段，该字段可应用在HTTP1.1版本分块传输编码时

#### 5.3.6 Transfer-Encoding

规定了传输报文主体时采用的编码方式

#### 5.3.7 Upgrade

用于检测HTTP协议是由可以使用更高的版本通信，其参数值用于指定一个完全不同的通信协议

#### 5.3.8 Via

使用Via为了追踪客户端与服务器之间的请求和响应报文的传输路径

#### 5.3.9 Warning

用于告知用户一些与缓存相关的问题的警告

![book-http/1573717290187](/book-http/1573717290187.png)

### 5.4 请求首部字段

#### 5.4.1 Accept

用于告知服务器，用户代理能够处理的媒体类型及媒体类型的相对优先级，可使用type/subtype这种形式，一次指定多种媒体类型

![book-http/1573717426930](/book-http/1573717426930.png)

#### 5.4.2 Accept-Charset

用于告知服务器用户代理支持的字符集及字符集的相对优先顺序，可一次性指定多种字符集，与受字段Accept一样，可以用权重q来表示相对优先级

#### 5.4.3 Accept-Encoding

用于告知服务器用户代理支持的内容编码及内容编码优先级顺序

Accept-Encoding: gzip, deflate

采用权重 q 值来表示相对优先级，这点与首部字段 Accept 相同。另
外，也可使用星号（*）作为通配符，指定任意的编码格式。

#### 5.4.4 Accept-Language

Accept-Language: zh-cn,zh;q=0.7,en-us,en;q=0.3

用于告知服务器能够处理的自然语言，支持权重q

#### 5.4.5 Authorization

用于告知服务器，用户代理的认证信息

#### 5.4.6 Expect

告知服务器，期望出现的某种特定行为，如果服务器无法理解，则会返回407

#### 5.4.7 Form

告知服务器使用用户代理的用户的电子邮件地址

#### 5.4.8 Host

用于虚拟主机运行在同一个IP上时候，做为区分，Host 首部字段在 HTTP/1.1 规范内是唯一一个必须被包含在请求内的首部字段。若服务器未设定主机名，那直接发送一个空值即可。

#### 5.4.9 If-Match

带有If-xxx的请求，服务器只有判断条件是真时，才会执行请求

![book-http/1573718024890](/book-http/1573718024890.png)

首部字段 If-Match，属附带条件之一，它会告知服务器匹配资源所用的实体标记值。这时的服务器无法使用弱 ETag 值。服务器会比对 If-Match 的字段值和资源的 ETag 值，仅当两者一致时，才会执行请求。反之，则返回状态码 412 recondition Failed 的响应。
还可以使用星号（*）指定 If-Match 的字段值。针对这种情况，服务器将会忽略 ETag 的值，只要资源存在就处理请求。

#### 5.4.10 If-Modified-Since

如果在它指定的日期后，资源发生了更新，服务器就会接受请求。![book-http/1573718168146](/book-http/1573718168146.png)

#### 5.4.11 Max-Forwards

用于追踪请求经过了几台服务器

#### 5.4.12 Range

对于只需要获取部分资源的范围请求，包含首字段Range可告知服务器资源的指定范围。

#### 5.4.13 Referer

首部字段Referer告知服务器请求的原始资源URI

### 5.5 响应首部字段

#### 5.5.1 Accept-Ranges

告知客户端服务器是否能处理范围请求。可处理时为bytes，否则为None

#### 5.5.2 Age

告知客户端，服务器在多久前创建了响应

#### 5.5.3 ETAG

告知客户端实体标识，他是一种将资源以字符串形式做唯一标识的方式，服务器会为美分资源分配对应的ETAG，另外当资源更新的时候ETAG也会更新

强ETAG：不论实体发生多么细微的变化都会改变其值

弱ETAG：只用于提示资源是否相同，只有资源发生了根本改变，产生差异时才会改变ETAG，这时会在字段开始处附加W/

ETag: W/"usagi-1234"

#### 5.5.4 Location

用于将响应接受方引导至某个与请求URI位置不同的资源

#### 5.5.5 Retry-After

用于告知客户端应该在多久之后再次发送请求

#### 5.5.6 Server

用于标识服务端的应用程序信息

### 5.6 实体首部字段

#### 5.6.1 Allow

告知客户端能够支持Request-URI指定资源的所有HTTP方法，当服务器不知道方法时，会以405 Method Not Allowed返回

#### 5.6.2 Content-Encoding

告知客户端服务器对实体的主体部分选用的内容编码格式

#### 5.6.3 Content-Language

告知客户端，实体主体使用的自然语言

#### 5.6.4 Content-Length

告知客户端，实体主体部分的大小

#### 5.6.5 Content-Type

首部字段说明了实体主体内对象的媒体类型

#### 5.6.6 Expires

告知客户端资源失效的日期

#### 5.6.7 Last-Modified

告知客户端资源最终的修改时间

### 5.7 Cookie首部字段

![book-http/1573719947424](/book-http/1573719947424.png)

Set-Cookie字段属性

![book-http/1573719969736](/book-http/1573719969736.png)

## 六、HTTPS

HTTP缺点：通信使用明文、无法验证通信方身份、无法验证报文完整性

### 6.1 HTTPS是身披SSL外壳的HTTP

HTTPS只是HTTP通信接口部分用SSL和TLS协议代替而已

![book-http/1573721528634](/book-http/1573721528634.png)

具体参考书籍第七章

## 七、基于HTTP追加的协议

### 7.1 消除HTTP瓶颈的SPDY

#### 7.1.1 HTTP瓶颈

一条连接上只可发送一个请求

请求只能从客户端开始，客户端不可以接受除响应以外的指令

请求/响应首部未经压缩就发送，首部信息越多延迟越大

发送冗长的首部，每次互相发送相同的首部造成的浪费较多

可任意选择数量压缩格式，非强制压缩发送

#### 7.1.1 SPDY的设计与功能

SPDY没有完全改写HTTP协议，而是在TCP/IP的应用层与运输层之间通过新加会话层的形式运作。同时，考虑安全性，通信中还使用SSL。

SPDY以会话层的形式加入，控制对数据的流动，但还是采用HTTP建立连接

![book-http/1573723324123](/book-http/1573723324123.png)

使用SPDY后，HTTP协议获得以下功能：

多路复用流

通过单一的TCP连接，可以无限制处理多个HTTP请求。所有请求的处理都在一条TCP连接上完成，因此TCP处理效率很高

赋予请求优先级

SPDY不仅可以无限制地并发处理请求，还可以给请求逐个分配有限级顺序，这样主要是为了在发送多个请求时，解决因带宽低而导致响应变慢的问题

压缩HTTP首部

推送功能

支持服务器主动向客户端推送数据

服务器提示功能

服务器可以主动提示客户端所需的资源

